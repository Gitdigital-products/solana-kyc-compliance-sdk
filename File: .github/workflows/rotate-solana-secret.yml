name: Rotate Solana Devnet Keypair

on:
  schedule:
    - cron: "0 0 1 * *" # runs at midnight on the 1st of every month UTC
  workflow_dispatch: # allow manual trigger

jobs:
  rotate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install requests pynacl

      - name: Generate new Solana keypair
        run: |
          mkdir -p ~/.config/solana
          solana-keygen new --no-bip39-passphrase --outfile ~/.config/solana/id.json
          echo "âœ… New keypair generated"
          solana address > ./public_key.txt
        env:
          PATH: /home/runner/.local/share/solana/install/active_release/bin:$PATH

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Run Secret Update Script
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }} # Personal Access Token with repo + admin:repo_hook
        run: |
          python3 update_github_secret.py

      - name: Output new public key
        run: cat ./public_key.txt
