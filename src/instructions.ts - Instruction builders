cat > src/instructions.ts << 'EOF'
import {
  PublicKey,
  SystemProgram,
  SYSVAR_RENT_PUBKEY,
  SYSVAR_CLOCK_PUBKEY,
  TransactionInstruction,
} from '@solana/web3.js';
import * as borsh from 'borsh';
import {
  InvestorData,
  CompliancePolicy,
  KYCLevel,
  InvestorType,
  AccreditationStatus,
} from './types';
import { PDA } from './pda';
import { ERROR_CODES } from './constants';

/**
 * Instruction data schemas
 */
class RegisterInvestorData {
  tag = 0;
  investorData: InvestorData;

  constructor(investorData: InvestorData) {
    this.investorData = investorData;
  }

  static schema = new Map([
    [
      RegisterInvestorData,
      {
        kind: 'struct',
        fields: [
          ['tag', 'u8'],
          ['investorData', {
            kind: 'struct',
            fields: [
              ['kycLevel', 'u8'],
              ['countryCode', 'string'],
              ['investorType', 'u8'],
              ['accreditationStatus', 'u8'],
            ],
          }],
        ],
      },
    ],
  ]);
}

class UpdatePolicyData {
  tag = 2;
  policy: CompliancePolicy;

  constructor(policy: CompliancePolicy) {
    this.policy = policy;
  }

  static schema = new Map([
    [
      UpdatePolicyData,
      {
        kind: 'struct',
        fields: [
          ['tag', 'u8'],
          ['policy', {
            kind: 'struct',
            fields: [
              ['requireKYCForTransfer', 'u8'],
              ['allowAnonymousSender', 'u8'],
              ['allowAnonymousReceiver', 'u8'],
              ['maxTransferAmount', 'u64'],
              ['minKYCLevel', 'u8'],
              ['supportedCountries', ['string']],
              ['restrictedCountries', ['string']],
              ['isActive', 'u8'],
              ['requireAccreditation', 'u8'],
              ['maxWalletsPerInvestor', 'u32'],
            ],
          }],
        ],
      },
    ],
  ]);
}

class ValidateTransferData {
  tag = 6;
  amount: bigint;

  constructor(amount: bigint) {
    this.amount = amount;
  }

  static schema = new Map([
    [
      ValidateTransferData,
      {
        kind: 'struct',
        fields: [
          ['tag', 'u8'],
          ['amount', 'u64'],
        ],
      },
    ],
  ]);
}

/**
 * Instruction builders for the compliance program
 */
export class ComplianceInstructions {
  constructor(private programId: PublicKey, private pda: PDA) {}

  /**
   * Create register investor instruction
   */
  async registerInvestor(
    payer: PublicKey,
    investorWallet: PublicKey,
    investorData: InvestorData
  ): Promise<TransactionInstruction> {
    const [registryPda] = await this.pda.getComplianceRegistry();
    const [investorPda] = await this.pda.getInvestorRecord(investorWallet);

    const data = new RegisterInvestorData({
      ...investorData,
      kycLevel: investorData.kycLevel as number,
      investorType: investorData.investorType as number,
      accreditationStatus: investorData.accreditationStatus as number,
    });

    const instructionData = borsh.serialize(
      RegisterInvestorData.schema,
      data
    );

    return new TransactionInstruction({
      keys: [
        { pubkey: payer, isSigner: true, isWritable: true },
        { pubkey: registryPda, isSigner: false, isWritable: true },
        { pubkey: investorPda, isSigner: false, isWritable: true },
        { pubkey: investorWallet, isSigner: false, isWritable: false },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
      ],
      programId: this.programId,
      data: Buffer.from(instructionData),
    });
  }

  /**
   * Create revoke investor instruction
   */
  async revokeInvestor(
    admin: PublicKey,
    investorWallet: PublicKey
  ): Promise<TransactionInstruction> {
    const [registryPda] = await this.pda.getComplianceRegistry();
    const [investorPda] = await this.pda.getInvestorRecord(investorWallet);

    const instructionData = Buffer.from([1]); // tag for revoke investor

    return new TransactionInstruction({
      keys: [
        { pubkey: admin, isSigner: true, isWritable: false },
        { pubkey: registryPda, isSigner: false, isWritable: true },
        { pubkey: investorPda, isSigner: false, isWritable: true },
      ],
      programId: this.programId,
      data: instructionData,
    });
  }

  /**
   * Create update policy instruction
   */
  async updatePolicy(
    admin: PublicKey,
    policy: CompliancePolicy
  ): Promise<TransactionInstruction> {
    const [policyPda] = await this.pda.getPolicyConfig();

    const data = new UpdatePolicyData(policy);
    const instructionData = borsh.serialize(
      UpdatePolicyData.schema,
      data
    );

    return new TransactionInstruction({
      keys: [
        { pubkey: admin, isSigner: true, isWritable: false },
        { pubkey: policyPda, isSigner: false, isWritable: true },
      ],
      programId: this.programId,
      data: Buffer.from(instructionData),
    });
  }

  /**
   * Create set admin instruction
   */
  async setAdmin(
    currentAdmin: PublicKey,
    newAdmin: PublicKey
  ): Promise<TransactionInstruction> {
    const [registryPda] = await this.pda.getComplianceRegistry();
    const [policyPda] = await this.pda.getPolicyConfig();

    const instructionData = Buffer.from([3]); // tag for set admin

    return new TransactionInstruction({
      keys: [
        { pubkey: currentAdmin, isSigner: true, isWritable: false },
        { pubkey: newAdmin, isSigner: false, isWritable: false },
        { pubkey: registryPda, isSigner: false, isWritable: true },
        { pubkey: policyPda, isSigner: false, isWritable: true },
      ],
      programId: this.programId,
      data: instructionData,
    });
  }

  /**
   * Create freeze wallet instruction
   */
  async freezeWallet(
    admin: PublicKey,
    investorWallet: PublicKey,
    freeze: boolean = true
  ): Promise<TransactionInstruction> {
    const [investorPda] = await this.pda.getInvestorRecord(investorWallet);
    const [policyPda] = await this.pda.getPolicyConfig();

    const instructionData = Buffer.from([freeze ? 4 : 5]); // tag for freeze/unfreeze

    return new TransactionInstruction({
      keys: [
        { pubkey: admin, isSigner: true, isWritable: false },
        { pubkey: investorPda, isSigner: false, isWritable: true },
        { pubkey: policyPda, isSigner: false, isWritable: false },
      ],
      programId: this.programId,
      data: instructionData,
    });
  }

  /**
   * Create validate transfer instruction (for transfer hook)
   */
  async validateTransfer(
    programId: PublicKey,
    source: PublicKey,
    destination: PublicKey,
    authority: PublicKey,
    amount: bigint
  ): Promise<TransactionInstruction> {
    const [sourceRecord] = await this.pda.getInvestorRecord(source);
    const [destRecord] = await this.pda.getInvestorRecord(destination);
    const [policyPda] = await this.pda.getPolicyConfig();

    const data = new ValidateTransferData(amount);
    const instructionData = borsh.serialize(
      ValidateTransferData.schema,
      data
    );

    return new TransactionInstruction({
      keys: [
        { pubkey: programId, isSigner: false, isWritable: false },
        { pubkey: source, isSigner: false, isWritable: false },
        { pubkey: destination, isSigner: false, isWritable: false },
        { pubkey: authority, isSigner: false, isWritable: false },
        { pubkey: sourceRecord, isSigner: false, isWritable: false },
        { pubkey: destRecord, isSigner: false, isWritable: false },
        { pubkey: policyPda, isSigner: false, isWritable: false },
        { pubkey: SYSVAR_CLOCK_PUBKEY, isSigner: false, isWritable: false },
      ],
      programId: this.programId,
      data: Buffer.from(instructionData),
    });
  }

  /**
   * Create initialize registry instruction
   */
  async initializeRegistry(admin: PublicKey): Promise<TransactionInstruction> {
    const [registryPda] = await this.pda.getComplianceRegistry();

    const instructionData = Buffer.from([7]); // tag for initialize registry

    return new TransactionInstruction({
      keys: [
        { pubkey: admin, isSigner: true, isWritable: true },
        { pubkey: registryPda, isSigner: false, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
      ],
      programId: this.programId,
      data: instructionData,
    });
  }

  /**
   * Create initialize policy instruction
   */
  async initializePolicy(admin: PublicKey): Promise<TransactionInstruction> {
    const [policyPda] = await this.pda.getPolicyConfig();

    const instructionData = Buffer.from([8]); // tag for initialize policy

    return new TransactionInstruction({
      keys: [
        { pubkey: admin, isSigner: true, isWritable: true },
        { pubkey: policyPda, isSigner: false, isWritable: true },
        { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
      ],
      programId: this.programId,
      data: instructionData,
    });
  }
}
EOF