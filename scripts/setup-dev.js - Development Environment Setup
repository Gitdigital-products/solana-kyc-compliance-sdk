#!/usr/bin/env node

/**
 * Development Environment Setup Script
 * One-command setup for new contributors
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üöÄ Setting up Solana KYC SDK development environment...\n');

// Check prerequisites
function checkPrerequisites() {
  console.log('üîç Checking prerequisites...');
  
  try {
    // Node.js version
    const nodeVersion = execSync('node --version').toString().trim();
    console.log(`‚úÖ Node.js: ${nodeVersion}`);
    
    if (!nodeVersion.startsWith('v18') && !nodeVersion.startsWith('v20')) {
      console.warn('‚ö†Ô∏è  Recommended: Node.js 18 or 20');
    }
    
    // npm/yarn
    try {
      const npmVersion = execSync('npm --version').toString().trim();
      console.log(`‚úÖ npm: ${npmVersion}`);
    } catch {
      console.log('‚úÖ yarn: (using yarn)');
    }
    
    // Git
    const gitVersion = execSync('git --version').toString().trim();
    console.log(`‚úÖ ${gitVersion}`);
    
  } catch (error) {
    console.error('‚ùå Missing prerequisites:', error.message);
    process.exit(1);
  }
}

// Install dependencies
function installDependencies() {
  console.log('\nüì¶ Installing dependencies...');
  
  try {
    execSync('npm install', { stdio: 'inherit' });
    console.log('‚úÖ Dependencies installed');
  } catch (error) {
    console.error('‚ùå Failed to install dependencies');
    process.exit(1);
  }
}

// Setup environment
function setupEnvironment() {
  console.log('\n‚öôÔ∏è  Setting up environment...');
  
  const envExample = path.join(__dirname, '..', '.env.example');
  const envFile = path.join(__dirname, '..', '.env');
  
  if (!fs.existsSync(envFile) && fs.existsSync(envExample)) {
    fs.copyFileSync(envExample, envFile);
    console.log('‚úÖ Created .env file from .env.example');
    console.log('‚ö†Ô∏è  Remember to update .env with your actual values');
  } else if (fs.existsSync(envFile)) {
    console.log('‚úÖ .env file already exists');
  }
}

// Verify setup
function verifySetup() {
  console.log('\nüß™ Verifying setup...');
  
  try {
    // TypeScript compilation
    console.log('üìù Checking TypeScript compilation...');
    execSync('npx tsc --noEmit', { stdio: 'pipe' });
    console.log('‚úÖ TypeScript compilation successful');
    
    // Tests
    console.log('üß™ Running tests...');
    execSync('npm test -- --passWithNoTests', { stdio: 'pipe' });
    console.log('‚úÖ Tests pass');
    
    // Linting
    console.log('üîç Checking code style...');
    execSync('npx eslint src/ --max-warnings 0', { stdio: 'pipe' });
    console.log('‚úÖ Code style passes');
    
  } catch (error) {
    console.warn('‚ö†Ô∏è  Setup verification warnings:', error.message);
    console.log('Some checks failed, but development environment is ready');
  }
}

// Main setup process
async function main() {
  console.log('='.repeat(60));
  console.log('SOLANA KYC SDK - DEVELOPMENT SETUP');
  console.log('='.repeat(60));
  
  checkPrerequisites();
  installDependencies();
  setupEnvironment();
  verifySetup();
  
  console.log('\n' + '='.repeat(60));
  console.log('üéâ SETUP COMPLETE!');
  console.log('='.repeat(60));
  console.log('\nNext steps:');
  console.log('1. Update .env file with your configuration');
  console.log('2. Review CONTRIBUTING.md for guidelines');
  console.log('3. Check out /examples/ for implementation examples');
  console.log('4. Run `npm run dev` to start development server');
  console.log('\nHappy coding! üöÄ\n');
}

main().catch(console.error);