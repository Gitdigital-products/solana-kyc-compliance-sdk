cat > ARCHITECTURE.md << 'EOF'
# ğŸ—ï¸ Architecture Documentation

## System Overview

The Solana KYC Compliance SDK is a comprehensive on-chain compliance solution consisting of three main components:

1. **On-Chain Program (Rust)** - Core compliance logic and state management
2. **TypeScript SDK** - Developer interface and transaction building
3. **Token Extensions Integration** - Native compliance for SPL tokens

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚External Systems                         â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚â”‚ KYC/AML     â”‚  â”‚  Oracles    â”‚  â”‚  Identity        â”‚    â”‚
â”‚â”‚ Providers   â”‚  â”‚             â”‚  â”‚  Providers       â”‚    â”‚
â”‚â”‚ (Sumsub,    â”‚  â”‚ (Chainlink, â”‚  â”‚  (Worldcoin,     â”‚    â”‚
â”‚â”‚  Jumio, etc)â”‚  â”‚  Pyth)      â”‚  â”‚   Civic)         â”‚    â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                 â”‚                    â”‚
â–¼                 â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Application Layer                           â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚â”‚              Your DeFi Application                  â”‚    â”‚
â”‚â”‚  â€¢ DEX/AMM         â€¢ Lending Platform               â”‚    â”‚
â”‚â”‚  â€¢ RWA Platform    â€¢ Payment System                 â”‚    â”‚
â”‚â”‚  â€¢ NFT Marketplace â€¢ Institutional Portal           â”‚    â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Compliance SDK Layer                        â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚â”‚          TypeScript Compliance SDK                  â”‚    â”‚
â”‚â”‚  â€¢ Client API       â€¢ Instruction Builders          â”‚    â”‚
â”‚â”‚  â€¢ Transaction Helpers â€¢ PDA Utilities              â”‚    â”‚
â”‚â”‚  â€¢ Error Mapping    â€¢ Configuration                 â”‚    â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚On-Chain Program Layer                       â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚â”‚         KYC Compliance Program (Rust)               â”‚    â”‚
â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚â”‚  â”‚ Instructionsâ”‚   â”‚    State    â”‚   â”‚  Errors  â”‚  â”‚    â”‚
â”‚â”‚  â”‚ â€¢ Register  â”‚   â”‚ â€¢ Registry  â”‚   â”‚ â€¢ Custom â”‚  â”‚    â”‚
â”‚â”‚  â”‚ â€¢ Revoke    â”‚   â”‚ â€¢ Policy    â”‚   â”‚  error   â”‚  â”‚
â”‚â”‚  â”‚ â€¢ Update    â”‚   â”‚ â€¢ Investor  â”‚   â”‚  codes   â”‚  â”‚
â”‚â”‚  â”‚ â€¢ Freeze    â”‚   â”‚   Record    â”‚   â”‚          â”‚  â”‚
â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Solana Blockchain Layer                      â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚â”‚           Solana Runtime & Token Program            â”‚    â”‚
â”‚â”‚  â€¢ Account Model    â€¢ Transaction Processing        â”‚    â”‚
â”‚â”‚  â€¢ SPL Token Program â€¢ Token Extensions             â”‚    â”‚
â”‚â”‚  â€¢ PDA System       â€¢ Rent Exemption                â”‚    â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## Data Model

### Core Accounts

#### 1. Compliance Registry (PDA)
**Address**: `[program_id, "compliance-registry"]`
**Purpose**: Global program state and statistics

```rust
pub struct ComplianceRegistry {
    pub admin: Pubkey,           // Current admin authority
    pub bump: u8,                // PDA bump
    pub investor_count: u64,     // Active investors
    pub total_registered: u64,   // Total registrations
    pub total_revoked: u64,      // Total revocations
    pub version: u8,             // Protocol version
}
```

2. Policy Configuration (PDA)

Address: [program_id, "policy-config"]
Purpose:Compliance rules and settings

```rust
pub struct PolicyConfig {
    pub admin: Pubkey,                  // Admin authority
    pub bump: u8,                       // PDA bump
    pub policy: CompliancePolicy,       // Current policy
    pub permanent_delegate: Pubkey,     // Freeze authority
    pub is_transfer_hook_enabled: bool, // Hook status
    pub last_updated: i64,              // Last update timestamp
}
```

3. Investor Record (PDA)

Address: [program_id, "investor-record", investor_wallet]
Purpose:Per-investor compliance data

```rust
pub struct InvestorRecord {
    pub investor_wallet: Pubkey,    // Investor's wallet
    pub bump: u8,                   // PDA bump
    pub kyc_level: u8,              // KYC verification level
    pub country_code: String,       // ISO country code
    pub is_verified: bool,          // Verification status
    pub is_frozen: bool,            // Freeze status
    pub registration_date: i64,     // Registration timestamp
    pub last_updated: i64,          // Last update timestamp
    pub total_transfers: u64,       // Total transfers made
    pub total_volume: u64,          // Total transfer volume
    pub investor_type: u8,          // Type of investor
    pub accreditation_status: u8,   // Accreditation status
    pub wallet_count: u32,          // Linked wallets
}
```

Policy Structure

```rust
pub struct CompliancePolicy {
    pub require_kyc_for_transfer: bool,   // KYC requirement
    pub allow_anonymous_sender: bool,     // Allow unregistered senders
    pub allow_anonymous_receiver: bool,   // Allow unregistered receivers
    pub max_transfer_amount: u64,         // Max transfer in lamports
    pub min_kyc_level: u8,                // Minimum KYC level required
    pub supported_countries: Vec<String>, // Allowed countries
    pub restricted_countries: Vec<String>,// Blocked countries
    pub is_active: bool,                  // Policy active status
    pub require_accreditation: bool,      // Accreditation requirement
    pub max_wallets_per_investor: u32,    // Max wallets per investor
}
```

Instruction Flow

1. Investor Registration

```
Sequence Diagram:
â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚     â”‚  App   â”‚     â”‚ SDK  â”‚     â”‚  On-Chain    â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚             â”‚                 â”‚
   â”‚   Complete  â”‚             â”‚                 â”‚
   â”‚â”€â”€â”€â”€â”€KYCâ”€â”€â”€â”€â–ºâ”‚             â”‚                 â”‚
   â”‚             â”‚             â”‚                 â”‚
   â”‚             â”‚ Prepare     â”‚                 â”‚
   â”‚             â”‚ investor    â”‚                 â”‚
   â”‚             â”‚ data        â”‚                 â”‚
   â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
   â”‚             â”‚             â”‚                 â”‚
   â”‚             â”‚             â”‚ Build register  â”‚
   â”‚             â”‚             â”‚ instruction     â”‚
   â”‚             â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚             â”‚             â”‚                 â”‚
   â”‚             â”‚             â”‚                 â”‚â”€â”
   â”‚             â”‚             â”‚                 â”‚ â”‚ Validate inputs
   â”‚             â”‚             â”‚                 â”‚ â”‚ Create PDA
   â”‚             â”‚             â”‚                 â”‚ â”‚ Store record
   â”‚             â”‚             â”‚                 â”‚ â”‚ Update registry
   â”‚             â”‚             â”‚                 â”‚â—„â”˜
   â”‚             â”‚             â”‚                 â”‚
   â”‚             â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚                 â”‚
   â”‚             â”‚             â”‚                 â”‚
```

2. Transfer Validation (Token Extension Hook)

```
Sequence Diagram:
â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚     â”‚ Token  â”‚     â”‚ Transfer   â”‚     â”‚  Compliance  â”‚
â”‚      â”‚     â”‚Program â”‚     â”‚   Hook     â”‚     â”‚   Program    â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚                 â”‚                   â”‚
   â”‚ Initiate    â”‚                 â”‚                   â”‚
   â”‚ transfer    â”‚                 â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚                   â”‚
   â”‚             â”‚                 â”‚                   â”‚
   â”‚             â”‚ Call transfer   â”‚                   â”‚
   â”‚             â”‚ hook            â”‚                   â”‚
   â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
   â”‚             â”‚                 â”‚                   â”‚
   â”‚             â”‚                 â”‚ Call compliance   â”‚
   â”‚             â”‚                 â”‚ check             â”‚
   â”‚             â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚             â”‚                 â”‚                   â”‚
   â”‚             â”‚                 â”‚                   â”‚â”€â”
   â”‚             â”‚                 â”‚                   â”‚ â”‚ Load sender record
   â”‚             â”‚                 â”‚                   â”‚ â”‚ Load receiver record
   â”‚             â”‚                 â”‚                   â”‚ â”‚ Load policy
   â”‚             â”‚                 â”‚                   â”‚ â”‚ Validate all rules
   â”‚             â”‚                 â”‚                   â”‚ â”‚ Return result
   â”‚             â”‚                 â”‚                   â”‚â—„â”˜
   â”‚             â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚             â”‚                 â”‚                   â”‚
   â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
   â”‚             â”‚                 â”‚                   â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                   â”‚
   â”‚             â”‚                 â”‚                   â”‚
```

Off-Chain â†’ On-Chain Sync Architecture

Integration Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Off-Chain Systems                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  KYC API    â”‚    â”‚  AML API    â”‚    â”‚  Identity   â”‚    â”‚
â”‚  â”‚   â€¢ Sumsub  â”‚    â”‚   â€¢ Chain-  â”‚    â”‚   â€¢ World-  â”‚    â”‚
â”‚  â”‚   â€¢ Jumio   â”‚    â”‚     analysisâ”‚    â”‚     coin    â”‚    â”‚
â”‚  â”‚   â€¢ Onfido  â”‚    â”‚   â€¢ Sanctionâ”‚    â”‚   â€¢ Civic   â”‚    â”‚
â”‚  â”‚             â”‚    â”‚     lists    â”‚    â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                  â”‚                  â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                            â”‚                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚  Your Backend â”‚                      â”‚
â”‚                    â”‚  â€¢ Process    â”‚                      â”‚
â”‚                    â”‚    results    â”‚                      â”‚
â”‚                    â”‚  â€¢ Generate   â”‚                      â”‚
â”‚                    â”‚    proof      â”‚                      â”‚
â”‚                    â”‚  â€¢ Call SDK   â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                            â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    On-Chain Program                         â”‚
â”‚                                                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚  Register   â”‚                         â”‚
â”‚                    â”‚  Investor   â”‚                         â”‚
â”‚                    â”‚             â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚  Investor     â”‚                      â”‚
â”‚                    â”‚  Record PDA   â”‚                      â”‚
â”‚                    â”‚               â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Example Integration Code

```typescript
// Backend integration with KYC provider
async function processKYCResult(kycResult: any) {
  // 1. Verify KYC provider signature
  const isValid = await verifyKYCProviderSignature(kycResult);
  
  if (!isValid) {
    throw new Error('Invalid KYC signature');
  }
  
  // 2. Map to on-chain format
  const investorData = {
    kycLevel: mapKYCLevel(kycResult.level),
    countryCode: kycResult.country,
    investorType: mapInvestorType(kycResult.type),
    accreditationStatus: mapAccreditation(kycResult.accredited),
  };
  
  // 3. Check if wallet already registered
  const existingRecord = await client.getInvestorRecord(kycResult.wallet)
    .catch(() => null);
  
  if (existingRecord) {
    // Update existing record
    await client.revoke(adminKeypair, kycResult.wallet);
  }
  
  // 4. Register on-chain
  const signature = await client.register(
    payerKeypair,
    kycResult.wallet,
    investorData
  );
  
  // 5. Store proof on-chain (optional)
  await storeKYCPProofOnChain(kycResult.proof, signature);
  
  return signature;
}
```

Security Assumptions

1. Program Security

Â· âœ… PDA-based accounts - All critical accounts are PDAs
Â· âœ… Admin controls - Multi-sig capable admin authority
Â· âœ… Input validation - All inputs validated on-chain
Â· âœ… No upgrade backdoor - Immutable program logic
Â· âœ… Rent exemption - All accounts rent-exempt

2. Token Extensions Security

Â· âœ… Transfer Hook - Only called by Token Program
Â· âœ… Permanent Delegate - Controlled by admin PDA
Â· âœ… No mint/freeze override - Compliance program only

3. Integration Security

Â· âš ï¸ KYC Provider Trust - Assumes provider validity
Â· âš ï¸ Oracle Security - Assumes oracle accuracy
Â· âš ï¸ Key Management - Assumes secure key storage

4. Economic Security

Â· âœ… No economic attack vectors - No value extraction
Â· âœ… Gas optimization - Minimal transaction costs
Â· âœ… No MEV opportunities - No front-running benefits

Limitations

1. Technical Limitations

Â· Solana Constraints: Account size limits, compute units
Â· Token Extensions: Requires Token-2022 program
Â· Cross-chain: Solana-only, no cross-chain compliance

2. Compliance Limitations

Â· Jurisdictional: Cannot enforce all global regulations
Â· Identity: Off-chain identity verification required
Â· AML: Basic AML, not full transaction monitoring

3. Scalability Limitations

Â· Global State: Single policy for all tokens
Â· Customization: Limited per-token customization
Â· Upgrades: Policy changes require admin action

4. Privacy Limitations

Â· On-chain Data: All compliance data is public
Â· No ZK Proofs: No zero-knowledge privacy
Â· Transparency: Complete audit trail visible

Performance Considerations

1. Compute Budget

Â· Registration: ~20,000 units
Â· Transfer Check: ~10,000 units
Â· Policy Update: ~15,000 units
Â· Freeze/Unfreeze: ~5,000 units

2. Storage Costs

Â· Investor Record: ~100 bytes Ã— rent rate
Â· Registry: ~100 bytes Ã— rent rate
Â· Policy: ~200 bytes Ã— rent rate

3. Network Throughput

Â· Theoretical: 1,000+ registrations/second
Â· Practical: 100-200 registrations/second
Â· Transfer Checks: ~5,000/second (via hooks)

Future Extensions

Planned Features

1. Multi-chain Compliance - Cross-chain identity bridging
2. ZK Compliance - Privacy-preserving verification
3. Dynamic Policies - Time-based and event-based rules
4. Delegated Authorities - Sub-admins for specific functions
5. Compliance Oracles - Real-time regulatory updates

Integration Targets

1. Solana Program Library - Standard compliance interface
2. Major DEXs - Jupiter, Orca, Raydium integration
3. Wallet Providers - Phantom, Solflare, Backpack
4. RWA Platforms - Real-world asset tokenization
5. Institutional Custodians - Fireblocks, Copper, Anchorage

Audit & Security

Audit Status

Â· âœ… Internal Review - Complete
Â· â³ External Audit - Planned Q2 2024
Â· â³ Formal Verification - Planned

Security Best Practices

1. Use multi-sig for admin keys
2. Regular policy review and updates
3. Monitor for suspicious activity
4. Maintain upgrade emergency procedures
5. Keep off-chain integration secure

Conclusion

This architecture provides a robust foundation for on-chain compliance while maintaining the composability and programmability that makes Solana unique. By leveraging Token Extensions natively, we enable seamless compliance integration without sacrificing performance or user experience.

The system is designed to be:

Â· Extensible - Add new compliance rules and integrations
Â· Composable - Work with any Solana protocol
Â· Secure - PDA-based, admin-controlled, validated
Â· Performant - Minimal overhead, high throughput
Â· Transparent - All operations visible on-chain

For implementation details, see DEVELOPER_GUIDE.md.
EOF
